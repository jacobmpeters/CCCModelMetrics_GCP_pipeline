---
title: "Notifications QC"
author: "Kelsey Sanchez"
date: "Report reflects notifications data from: `r format(Sys.Date() - 8, '%B %d , %Y')` to `r format(Sys.Date() - 1, '%B %d , %Y')`"
header-includes:  
    \usepackage{placeins}


output:
  pdf_document:
    extra_dependencies: ["float"]
    toc: false
    keep_tex: yes
    fig_caption: true
---


This report reviews notification reminders to determine which messages were not sent per week as expected, duplicate notifications sent to participants, and notifications sent at a higher rate than expected. Tables of errors that have over 50 rows will be exported to a csv file and posted on Box here: https://nih.app.box.com/folder/254808757764


```{r library, include=FALSE}
library(bigrquery)
library(foreach)
library(stringr)
library(gtsummary)
library(data.table) ###to write or read and data management 
library(tidyverse) ###for data management
library(dplyr) ###data management
library(sqldf) ##sql
library(lubridate) ###date time
library(kableExtra)
library(glue)

bq_auth()

project <- "nih-nci-dceg-connect-prod-6d04"

#######################################################################

### Set Box folders for output CSV files ###########
boxfolder <- 255743123858 # Active Box Folder


##### Making sure personal C drives aren't referenced if this code is being used by others


#Change to FALSE if referencing this code
write_to_local_drive = F #F

#local_drive="C:/Users/dowlingk2/Documents/Module-Missingness-and-Metrics/data/"    


### This function below is put before any write.csv functions, and "filename" is updated. It determines wheteher the file will be created locally or not.
#filename=
local_drive= ifelse(write_to_local_drive, "C:/Users/dowlingk2/Documents/GitHub/ccc_module_metrics_gcp_pipeline/", "")

currentDate <- Sys.Date()
```


# 1. Category/attempt combinations with no messages being sent on over the past week. 
```{r Overage, echo=FALSE, warning=FALSE, message=FALSE}

## Note there is no notification specID for BL Clin Bio Survey reminder and none for Biospecimen Survey Reminder 



Week_Without_Notification <- "-- Step 1: Filter notifications within the last week
WITH FilteredNotifications AS (
    SELECT 
        category,
        attempt,
        DATE(notification_time) AS notification_date
    FROM 
        `nih-nci-dceg-connect-prod-6d04.FlatConnect.notifications_JP`
    WHERE 
        DATE(notification_time) BETWEEN DATE_SUB(CURRENT_DATE(), INTERVAL 7 DAY) AND DATE_SUB(CURRENT_DATE(), INTERVAL 1 DAY)
),

-- Step 2: Define all possible notifications (excluding specific categories that have been have been discontinued and/or renamed)
AllPossibleNotifications AS (
    SELECT DISTINCT 
        category,
        attempt
    FROM 
        `nih-nci-dceg-connect-prod-6d04.FlatConnect.notifications_JP`
    WHERE 
        category NOT IN (
            'Baseline Biospecimen Scheduling Invitation',
            'Baseline Research Menstrual Cycle Survey Reminder 1',
            'Baseline Research Menstrual Cycle Survey Reminder 1st contact',
            'Baseline Research Menstrual Cycle Survey Reminder 2nd contact',
            'Baseline Research Menstrual Cycle Survey Reminder 3rd contact',
            'Baseline Research Menstrual Cycle Survey Reminder 4th contact',
            'HP Baseline Research Biospecimen Scheduling Invitation',
            'KPHI Support Message',
            'MF Baseline Biospecimen Scheduling Invitation',
            'Verified, BL Survey Reminders Backlog Pts 4th contact',
            'Verified, BL Survey Reminders Backlog Pts 5th contact',
            'Verified, BL Survey Reminders BacklogPts 6th Contact',
            'Verified, BL Survey Reminders BacklogPts 7th Contact',
            'Verified, BL Survey Reminders BacklogPts 8th Contact',
            'Verified, BL Survey Reminders BacklogPts 9th Contact',
            'Verified, BL Survey Reminder Backlog Pts',
            'Verified, BL Survey Reminders Backlog Pts',
            'Post-verification biospecimen update KPCO',
            'Post-verification biospecimen update KPGA',
            'Post-verification biospecimen update KPHI',
            'Post-verification biospecimen update KPNW',
            'Verified, BL Survey Reminders New Pts 7th Contact',
            'Verified, BL Survey Reminders New Pts 8th Contact',
            'Verified, BL Survey Reminders New Pts 9th Contact',
            'HF Baseline Biospecimen Scheduling Invitation',
            'Baseline Clinical Biospecimen Survey Reminder',
            'Biospecimen Home Collection Kit Reminder',
            'Biospecimen Home Collection Survey Reminder',
            'Biospecimen Survey Reminder',
            'Biospecimen Home Collection Acknowledgement',
            'newsletter',
            'eNewsletter'
        ) and 
        category NOT LIKE '% PI Change' and category NOT LIKE 'Prev. Blocked %' and 
        NOT (category = 'Verified, BL Survey Reminders' AND attempt = '2nd contact')
    UNION ALL
    SELECT 
        'Data Destruction Reminders' AS category,
        attempt
    FROM 
        UNNEST(['2nd contact', '3rd contact', '4th contact']) AS attempt
),

-- Step 3: Identify notifications that are not in FilteredNotifications
NotYetSentNotifications AS (
    SELECT 
        apn.category,
        apn.attempt
    FROM 
        AllPossibleNotifications apn
    LEFT JOIN 
        FilteredNotifications fn
    ON 
        apn.category = fn.category
        AND apn.attempt = fn.attempt
    WHERE 
        fn.category IS NULL
        AND fn.attempt IS NULL
)

-- Final Selection
SELECT DISTINCT
    category,
    attempt
FROM 
    NotYetSentNotifications
WHERE 
    attempt != '4th' -- Exclude rows where attempt is '4th', somehow not being excluded even though its outside the date range
ORDER BY 
    category, attempt ASC;"



Week_Without_Notification_table <- bq_project_query(project, Week_Without_Notification)
Week_Without_Notification_after_march2024 <- bq_table_download(Week_Without_Notification_table, bigint = "integer64") 


if (nrow(Week_Without_Notification_after_march2024) > 50) {
  cat("There are", nrow(Week_Without_Notification_after_march2024), "errors. This table has been made a csv and posted to Box, link in the report intro.")
  write.csv(Week_Without_Notification_after_march2024,glue("{local_drive}Week_Without_Notifications_{currentDate}_boxfolder_{boxfolder}.csv"),row.names = F,na="")
} else {
  if(nrow(Week_Without_Notification_after_march2024) == 0) {
  cat("No errors\n")
} else {
  knitr::kable(Week_Without_Notification_after_march2024) %>% kable_styling(latex_options = "HOLD_position")
}
}




```



\FloatBarrier


# 2. Participants receiving more than one contact attempt from the same category on the same day.




## The same participant received multiple 3 Month QOL Survey email reminders on the same day.
```{r QOL_email, echo=FALSE, message=FALSE, warning=FALSE}
QOL <- "SELECT distinct(p.Connect_ID), #distinct(n.token), 
category,
       DATE(notification_time) as repeat_date, 
       COUNT(*) as num_same_day_attempts
FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.notifications_JP` n
left join  `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` p
on p.token=n.token
WHERE category LIKE '%3mo QOL Survey Reminders%' and date(notification_time) >= (CURRENT_DATE()-7) 
and notificationType='email'
GROUP BY Connect_ID,category, DATE(notification_time)
HAVING COUNT(*) > 1"

QOL_table <- bq_project_query(project, QOL)
QOL_Em_invite <- bq_table_download(QOL_table, bigint = "integer64") 

# if (nrow(QOL_Em_invite) == 0) {
#   cat("No errors\n")
# } else {
#   knitr::kable(QOL_Em_invite) %>% kable_styling(latex_options = "scale_down")
# }

if (nrow(QOL_Em_invite) > 50) {
  cat("There are", nrow(QOL_Em_invite), "errors. This table has been made a csv and posted to Box, link in the report intro.")
  write.csv(QOL_Em_invite,glue("{local_drive}Multiple_QOL_Email_Notifications_{currentDate}_boxfolder_{boxfolder}.csv"),row.names = F,na="")
} else {
  if(nrow(QOL_Em_invite) == 0) {
  cat("No errors\n")
} else {
  knitr::kable(QOL_Em_invite) %>% kable_styling(latex_options = "scale_down")
}
}


```


\FloatBarrier


## The same participant received multiple 3 Month QOL Survey SMS reminders on the same day.
```{r QOL_sms, echo=FALSE, message=FALSE, warning=FALSE}
QOL <- "SELECT distinct(p.Connect_ID), #distinct(n.token), 
category,
       DATE(notification_time) as repeat_date, 
       COUNT(*) as num_same_day_attempts
FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.notifications_JP` n
left join  `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` p
on p.token=n.token
WHERE category LIKE '%3mo QOL Survey Reminders%' and date(notification_time) >= (CURRENT_DATE()-7) 
and notificationType='sms'
GROUP BY Connect_ID,category, DATE(notification_time)
HAVING COUNT(*) > 1"

QOL_table <- bq_project_query(project, QOL)
QOLSMS_invite <- bq_table_download(QOL_table, bigint = "integer64")

if (nrow(QOLSMS_invite) > 50) {
  cat("There are", nrow(QOLSMS_invite), "errors. This table has been made a csv and posted to Box, link in the report intro.")
  write.csv(QOLSMS_invite,glue("{local_drive}Multiple_QOL_SMS_Notifications_{currentDate}_boxfolder_{boxfolder}.csv"),row.names = F,na="")
} else {
  if(nrow(QOLSMS_invite) == 0) {
  cat("No errors\n")
} else {
  knitr::kable(QOLSMS_invite) %>% kable_styling(latex_options = "scale_down")
}
}



```




\FloatBarrier
## The same participant received multiple Baseline Research Biospecimen Survey reminders on the same day. Note, first contact attempt is sent at the time of the sample donation and the 2nd contact attempt is sent at 8pm that same day; for that reason we expect up to 2 contacts a day per participant. This table will identify any count higher than 2 per day.

\FloatBarrier
```{r RsBio, echo=FALSE, message=FALSE, warning=FALSE}
RsBio <- "SELECT DISTINCT p.Connect_ID, 
                MAX(category) AS category,
                DATE(notification_time) AS repeat_date, 
                COUNT(*) AS num_same_day_attempts
FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.notifications_JP` n
LEFT JOIN `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` p
ON p.token = n.token
WHERE category='Biospecimen Survey Reminder' OR category LIKE '%Baseline Research Biospecimen Survey Reminders%'
AND DATE(notification_time) >= (CURRENT_DATE() - 7)
#AND notificationType = 'email'
GROUP BY Connect_ID,repeat_date
HAVING COUNT(*) > 2"

RsBio_table <- bq_project_query(project, RsBio)
Rs_BioSrvy_invite <- bq_table_download(RsBio_table, bigint = "integer64") #currently 32 people - all 2



if (nrow(Rs_BioSrvy_invite) > 50) {
  cat("There are", nrow(Rs_BioSrvy_invite), "errors. This table has been made a csv and posted to Box, link in the report intro.")
  write.csv(Rs_BioSrvy_invite,glue("{local_drive}Multiple_Rs_BioSrvy_invite_reminders_{currentDate}_boxfolder_{boxfolder}.csv"),row.names = F,na="")
} else {
  if(nrow(Rs_BioSrvy_invite) == 0) {
  cat("No errors\n")
} else {
  knitr::kable(Rs_BioSrvy_invite) %>% kable_styling(latex_options = "scale_down")
}
}

```



\FloatBarrier
## The same participant received multiple Baseline Clinical Biospecimen Survey reminders on the same day. Note, first contact attempt is sent at the time of the sample donation and the 2nd contact attempt is sent at 8pm that same day; for that reason we expect up to 2 contacts a day per participant. This table will identify any count higher than 2 per day.
```{r ClBio, echo=FALSE, message=FALSE, warning=FALSE}
ClBio <- "SELECT DISTINCT p.Connect_ID, 
                MAX(category) AS category,
                DATE(notification_time) AS repeat_date, 
                COUNT(*) AS num_same_day_attempts
FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.notifications_JP` n
LEFT JOIN `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` p
ON p.token = n.token
WHERE (category LIKE '%Baseline Clinical Biospecimen Survey%' OR 
       category LIKE '%Baseline Clinical Blood and Urine Sample Survey Reminders%' OR
       category ='Baseline Clinical Blood and Urine Sample Survey Reminders')
AND DATE(notification_time) >= (CURRENT_DATE() - 7)
#AND notificationType = 'email'
GROUP BY Connect_ID,repeat_date
HAVING COUNT(*) > 2"

ClBio_table <- bq_project_query(project, ClBio)
Clin_BioSrvy_invite <- bq_table_download(ClBio_table, bigint = "integer64")


if (nrow(Clin_BioSrvy_invite) > 50) {
  cat("There are", nrow(Clin_BioSrvy_invite), "errors. This table has been made a csv and posted to Box, link in the report intro.")
  write.csv(Clin_BioSrvy_invite,glue("{local_drive}Multiple_Clin_BioSrvy_invite_reminders_{currentDate}_boxfolder_{boxfolder}.csv"),row.names = F,na="")
} else {
  if(nrow(Clin_BioSrvy_invite) == 0) {
  cat("No errors\n")
} else {
  knitr::kable(Clin_BioSrvy_invite) %>% kable_styling(latex_options = "scale_down")
}
}

```





\FloatBarrier


## The same participant received multiple Baseline Research Menstrual Cycle Survey email reminders on the same day. 
```{r BRM_email, echo=FALSE, message=FALSE, warning=FALSE}
BRM_email <- "SELECT distinct(p.Connect_ID), #distinct(n.token), 
category,
       DATE(notification_time) as repeat_date, 
       COUNT(*) as num_same_day_attempts
FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.notifications_JP` n
left join  `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` p
on p.token=n.token
WHERE category='Baseline Research Menstrual Cycle Survey Reminders' and date(notification_time) >= (CURRENT_DATE()-7)
AND notificationType = 'email'
GROUP BY Connect_ID,category, DATE(notification_time)
HAVING COUNT(*) > 1"

BRM_email_table <- bq_project_query(project, BRM_email)
BL_Rs_MensSrvy_Einvite <- bq_table_download(BRM_email_table, bigint = "integer64") #currently 39, max 4


if (nrow(BL_Rs_MensSrvy_Einvite) > 50) {
  cat("There are", nrow(BL_Rs_MensSrvy_Einvite), "errors. This table has been made a csv and posted to Box, link in the report intro.")
  write.csv(BL_Rs_MensSrvy_Einvite,glue("{local_drive}Multiple_BL_Rs_MensSrvy_Einvite_reminders_{currentDate}_boxfolder_{boxfolder}.csv"),row.names = F,na="")
} else {
  if(nrow(BL_Rs_MensSrvy_Einvite) == 0) {
  cat("No errors\n")
} else {
  knitr::kable(BL_Rs_MensSrvy_Einvite) %>% kable_styling(latex_options = "scale_down")
}
}


```

\FloatBarrier


## The same participant received multiple Baseline Research Menstrual Cycle Survey SMS reminders on the same day. 
```{r BRM_SMS, echo=FALSE, message=FALSE, warning=FALSE}
BRM_SMS <- "SELECT distinct(p.Connect_ID), #distinct(n.token), 
category,
       DATE(notification_time) as repeat_date, 
       COUNT(*) as num_same_day_attempts
FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.notifications_JP` n
left join  `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` p
on p.token=n.token
WHERE category='Baseline Research Menstrual Cycle Survey Reminders' and date(notification_time) >= (CURRENT_DATE()-7)
AND notificationType = 'sms'
GROUP BY Connect_ID,category, DATE(notification_time)
HAVING COUNT(*) > 1"

BRM_SMS_table <- bq_project_query(project, BRM_SMS)
BL_Rs_MensSrvy_SMSinvite <- bq_table_download(BRM_SMS_table, bigint = "integer64") #currently 39, max 4


if (nrow(BL_Rs_MensSrvy_SMSinvite) > 50) {
  cat("There are", nrow(BL_Rs_MensSrvy_SMSinvite), "errors. This table has been made a csv and posted to Box, link in the report intro.")
  write.csv(BL_Rs_MensSrvy_SMSinvite,glue("{local_drive}Multiple_BL_Rs_MensSrvy_SMSinvite_reminders_{currentDate}_boxfolder_{boxfolder}.csv"),row.names = F,na="")
} else {
  if(nrow(BL_Rs_MensSrvy_SMSinvite) == 0) {
  cat("No errors\n")
} else {
  knitr::kable(BL_Rs_MensSrvy_SMSinvite) %>% kable_styling(latex_options = "scale_down")
}
}


```

\FloatBarrier

## The same participant received multiple Baseline Clinical Menstrual Cycle Survey email reminders on the same day.  
```{r BCM_email, echo=FALSE, message=FALSE, warning=FALSE}
BCM_email <- "SELECT distinct(p.Connect_ID), #distinct(n.token), 
category,
       DATE(notification_time) as repeat_date, 
       COUNT(*) as num_same_day_attempts
FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.notifications_JP` n
left join  `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` p
on p.token=n.token
WHERE category LIKE '%Baseline Clinical Menstrual Cycle Survey%' and date(notification_time) >= (CURRENT_DATE()-7)
AND notificationType = 'email'
GROUP BY Connect_ID,category, DATE(notification_time)
HAVING COUNT(*) > 1"

BCM_email_table <- bq_project_query(project, BCM_email)
BL_Cl_MensSrvy_Einvite <- bq_table_download(BCM_email_table, bigint = "integer64") #currently 341, max 4


if (nrow(BL_Cl_MensSrvy_Einvite) > 50) {
  cat("There are", nrow(BL_Cl_MensSrvy_Einvite), "errors. This table has been made a csv and posted to Box, link in the report intro.")
  write.csv(BL_Cl_MensSrvy_Einvite,glue("{local_drive}Multiple_BL_Cl_MensSrvy_Einvite_reminders_{currentDate}_boxfolder_{boxfolder}.csv"),row.names = F,na="")
} else {
  if(nrow(BL_Cl_MensSrvy_Einvite) == 0) {
  cat("No errors\n")
} else {
  knitr::kable(BL_Cl_MensSrvy_Einvite) %>% kable_styling(latex_options = "scale_down")
}
}

```

\FloatBarrier

## The same participant received multiple Baseline Clinical Menstrual Cycle Survey sms reminders on the same day.  
```{r BCM_SMS, echo=FALSE, message=FALSE, warning=FALSE}
BCM_SMS <- "SELECT distinct(p.Connect_ID), #distinct(n.token), 
category,
       DATE(notification_time) as repeat_date, 
       COUNT(*) as num_same_day_attempts
FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.notifications_JP` n
left join  `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` p
on p.token=n.token
WHERE category LIKE '%Baseline Clinical Menstrual Cycle Survey%' and date(notification_time) >= (CURRENT_DATE()-7)
AND notificationType = 'sms'
GROUP BY Connect_ID,category, DATE(notification_time)
HAVING COUNT(*) > 1"

BCM_SMS_table <- bq_project_query(project, BCM_SMS)
BL_Cl_MensSrvy_SMSinvite <- bq_table_download(BCM_SMS_table, bigint = "integer64") #currently 341, max 4


if (nrow(BL_Cl_MensSrvy_SMSinvite) > 50) {
  cat("There are", nrow(BL_Cl_MensSrvy_SMSinvite), "errors. This table has been made a csv and posted to Box, link in the report intro.")
  write.csv(BL_Cl_MensSrvy_SMSinvite,glue("{local_drive}Multiple_BL_Cl_MensSrvy_SMSinvite_reminders_{currentDate}_boxfolder_{boxfolder}.csv"),row.names = F,na="")
} else {
  if(nrow(BL_Cl_MensSrvy_SMSinvite) == 0) {
  cat("No errors\n")
} else {
  knitr::kable(BL_Cl_MensSrvy_SMSinvite) %>% kable_styling(latex_options = "scale_down")
}
}

```

\FloatBarrier
## The same participant received multiple Cannot Be Verified notifications on the same day. 
```{r CBV, echo=FALSE, message=FALSE, warning=FALSE}
CBV <- "SELECT distinct(p.Connect_ID), #distinct(n.token), 
category,
       DATE(notification_time) as repeat_date, 
       COUNT(*) as num_same_day_attempts
FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.notifications_JP` n
left join  `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` p
on p.token=n.token
WHERE category LIKE '%Cannot Be Verified Notification%' and date(notification_time) >= (CURRENT_DATE()-7)
#AND notificationType = 'email'
GROUP BY Connect_ID,category, DATE(notification_time)
HAVING COUNT(*) > 1"

CBV_table <- bq_project_query(project, CBV)
CBV_rem <- bq_table_download(CBV_table, bigint = "integer64")


if (nrow(CBV_rem) > 50) {
  cat("There are", nrow(CBV_rem), "errors. This table has been made a csv and posted to Box, link in the report intro.")
  write.csv(CBV_rem,glue("{local_drive}Multiple_CBV_rem_reminders_{currentDate}_boxfolder_{boxfolder}.csv"),row.names = F,na="")
} else {
  if(nrow(CBV_rem) == 0) {
  cat("No errors\n")
} else {
  knitr::kable(CBV_rem) %>% kable_styling(latex_options = "scale_down")
}
}

```

\FloatBarrier
## The same participant received multiple Data Destruction reminders on the same day. 
```{r DDR, echo=FALSE, message=FALSE, warning=FALSE}
DDR <- "SELECT distinct(p.Connect_ID), #distinct(n.token), 
category,
       DATE(notification_time) as repeat_date, 
       COUNT(*) as num_same_day_attempts
FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.notifications_JP` n
left join  `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` p
on p.token=n.token
WHERE category LIKE '%Data Destruction Reminders%' and date(notification_time) >= (CURRENT_DATE()-7)
#AND notificationType = 'email'
GROUP BY Connect_ID,category, DATE(notification_time)
HAVING COUNT(*) > 1"

DDR_table <- bq_project_query(project, DDR)
Destruction_rem <- bq_table_download(DDR_table, bigint = "integer64")


if (nrow(Destruction_rem) > 50) {
  cat("There are", nrow(Destruction_rem), "errors. This table has been made a csv and posted to Box, link in the report intro.")
  write.csv(Destruction_rem,glue("{local_drive}Multiple_Destruction_rem_reminders_{currentDate}_boxfolder_{boxfolder}.csv"),row.names = F,na="")
} else {
  if(nrow(Destruction_rem) == 0) {
  cat("No errors\n")
} else {
  knitr::kable(Destruction_rem) %>% kable_styling(latex_options = "scale_down")
}
}


```

\FloatBarrier

## The same participant received multiple HIPAA revocation reminders on the same day. 
```{r HIPAA, echo=FALSE, message=FALSE, warning=FALSE}
HIPAA <- "SELECT distinct(p.Connect_ID), #distinct(n.token), 
category,
       DATE(notification_time) as repeat_date, 
       COUNT(*) as num_same_day_attempts
FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.notifications_JP` n
left join  `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` p
on p.token=n.token
WHERE category LIKE '%HIPAA revocation reminders%' and date(notification_time) >= (CURRENT_DATE()-7)
#AND notificationType = 'email'
GROUP BY Connect_ID,category, DATE(notification_time)
HAVING COUNT(*) > 1"

HIPAA_table <- bq_project_query(project, HIPAA)
HIPAA_rem <- bq_table_download(HIPAA_table, bigint = "integer64")


if (nrow(HIPAA_rem) > 50) {
  cat("There are", nrow(HIPAA_rem), "errors. This table has been made a csv and posted to Box, link in the report intro.")
  write.csv(HIPAA_rem,glue("{local_drive}Multiple_HIPAA_rem_reminders_{currentDate}_boxfolder_{boxfolder}.csv"),row.names = F,na="")
} else {
  if(nrow(HIPAA_rem) == 0) {
  cat("No errors\n")
} else {
  knitr::kable(HIPAA_rem) %>% kable_styling(latex_options = "scale_down")
}
}


```


\FloatBarrier
## The same participant received multiple HP Baseline Biospecimen invitations on the same day. 
```{r HPBB, echo=FALSE, message=FALSE, warning=FALSE}
HPBB <- "SELECT distinct(p.Connect_ID), #distinct(n.token), 
category,
       DATE(notification_time) as repeat_date, 
       COUNT(*) as num_same_day_attempts
FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.notifications_JP` n
left join  `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` p
on p.token=n.token
WHERE category='HP Baseline Biospecimen Invitation' and date(notification_time) >= (CURRENT_DATE()-7)
#AND notificationType = 'email'
GROUP BY Connect_ID,category, DATE(notification_time)
HAVING COUNT(*) > 1"

HPBB_table <- bq_project_query(project, HPBB)
HPBio_rem <- bq_table_download(HPBB_table, bigint = "integer64") #currently 483, max 5


if (nrow(HPBio_rem) > 50) {
  cat("There are", nrow(HPBio_rem), "errors. This table has been made a csv and posted to Box, link in the report intro.")
  write.csv(HPBio_rem,glue("{local_drive}Multiple_HPBio_rem_reminders_{currentDate}_boxfolder_{boxfolder}.csv"),row.names = F,na="")
} else {
  if(nrow(HPBio_rem) == 0) {
  cat("No errors\n")
} else {
  knitr::kable(HPBio_rem) %>% kable_styling(latex_options = "scale_down")
}
}


```



\FloatBarrier
## The same participant received multiple UC Baseline Biospecimen Scheduling invitations on the same day. 
```{r UCBB, echo=FALSE, message=FALSE, warning=FALSE}
UCBB <- "SELECT distinct(p.Connect_ID), #distinct(n.token), 
category,
       DATE(notification_time) as repeat_date, 
       COUNT(*) as num_same_day_attempts
FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.notifications_JP` n
left join  `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` p
on p.token=n.token
WHERE category LIKE '%UC Baseline Biospecimen Scheduling Invitation%' and date(notification_time) >= (CURRENT_DATE()-7)
#AND notificationType = 'email'
GROUP BY Connect_ID,category, DATE(notification_time)
HAVING COUNT(*) > 1"

UCBB_table <- bq_project_query(project, UCBB)
UCBio_rem <- bq_table_download(UCBB_table, bigint = "integer64") #currently 483, max 5


if (nrow(UCBio_rem) > 50) {
  cat("There are", nrow(UCBio_rem), "errors. This table has been made a csv and posted to Box, link in the report intro.")
  write.csv(UCBio_rem,glue("{local_drive}Multiple_UCBio_rem_reminders_{currentDate}_boxfolder_{boxfolder}.csv"),row.names = F,na="")
} else {
  if(nrow(UCBio_rem) == 0) {
  cat("No errors\n")
} else {
  knitr::kable(UCBio_rem) %>% kable_styling(latex_options = "scale_down")
}
}


```






\FloatBarrier
## The same participant received multiple KP baseline biospecimen invitations on the same day. 
```{r KPBio, echo=FALSE, message=FALSE, warning=FALSE}
KPBio <- "SELECT distinct(p.Connect_ID), #distinct(n.token), 
category,
       DATE(notification_time) as repeat_date, 
       COUNT(*) as num_same_day_attempts
FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.notifications_JP` n
left join  `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` p
on p.token=n.token
WHERE category LIKE '%baseline biospecimen invitations%' and date(notification_time) >= (CURRENT_DATE()-7)
#AND notificationType = 'email'
GROUP BY Connect_ID,category, DATE(notification_time)
HAVING COUNT(*) > 1"

KPBio_table <- bq_project_query(project, KPBio)
KPBio_rem <- bq_table_download(KPBio_table, bigint = "integer64") #currently 483, max 5


if (nrow(KPBio_rem) > 50) {
  cat("There are", nrow(KPBio_rem), "errors. This table has been made a csv and posted to Box, link in the report intro.")
  write.csv(KPBio_rem,glue("{local_drive}Multiple_KPBio_rem_reminders_{currentDate}_boxfolder_{boxfolder}.csv"),row.names = F,na="")
} else {
  if(nrow(KPBio_rem) == 0) {
  cat("No errors\n")
} else {
  knitr::kable(KPBio_rem) %>% kable_styling(latex_options = "scale_down")
}
}

```


\FloatBarrier
## The same participant received multiple HFH Verified, BL Survey Reminder and Biospecimen Scheduling Invite notifications on the same day. 
```{r HF_Srvy_Bio, echo=FALSE, message=FALSE, warning=FALSE}
HF_Srvy_Bio <- "SELECT distinct(p.Connect_ID), #distinct(n.token), 
category,
       DATE(notification_time) as repeat_date, 
       COUNT(*) as num_same_day_attempts
FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.notifications_JP` n
left join  `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` p
on p.token=n.token
WHERE category = 'HFH Verified, BL Survey Reminder and Biospecimen Scheduling Invite' 
and date(notification_time) >= (CURRENT_DATE()-7)
#AND notificationType = 'email'
GROUP BY Connect_ID,category, DATE(notification_time)
HAVING COUNT(*) > 1"

HF_Srvy_Bio_table <- bq_project_query(project, HF_Srvy_Bio)
HF_Srvy_Bio_rem <- bq_table_download(HF_Srvy_Bio_table, bigint = "integer64") #currently 483, max 5


if (nrow(HF_Srvy_Bio_rem) > 50) {
  cat("There are", nrow(HF_Srvy_Bio_rem), "errors. This table has been made a csv and posted to Box, link in the report intro.")
  write.csv(HF_Srvy_Bio_rem,glue("{local_drive}Multiple_HF_Srvy_Bio_rem_reminders_{currentDate}_boxfolder_{boxfolder}.csv"),row.names = F,na="")
} else {
  if(nrow(HF_Srvy_Bio_rem) == 0) {
  cat("No errors\n")
} else {
  knitr::kable(HF_Srvy_Bio_rem) %>% kable_styling(latex_options = "scale_down")
}
}

```


\FloatBarrier
## The same participant received multiple eNewsletter email notifications on the same day. 
```{r enews_email, echo=FALSE, message=FALSE, warning=FALSE}
enews_email <- "SELECT distinct(p.Connect_ID), #distinct(n.token), 
category,
       DATE(notification_time) as repeat_date, 
       COUNT(*) as num_same_day_attempts
FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.notifications_JP` n
left join  `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` p
on p.token=n.token
WHERE category='eNewsletter' and date(notification_time) >= (CURRENT_DATE()-7) and 
notificationType='email'
GROUP BY Connect_ID,category, DATE(notification_time)
HAVING COUNT(*) > 1"

enews_email_table <- bq_project_query(project, enews_email)
enews_email_rem <- bq_table_download(enews_email_table, bigint = "integer64") #currently 5 - all 2


if (nrow(enews_email_rem) > 50) {
  cat("There are", nrow(enews_email_rem), "errors. This table has been made a csv and posted to Box, link in the report intro.")
  write.csv(enews_email_rem,glue("{local_drive}Multiple_enews_email_rem_reminders_{currentDate}_boxfolder_{boxfolder}.csv"),row.names = F,na="")
} else {
  if(nrow(enews_email_rem) == 0) {
  cat("No errors\n")
} else {
  knitr::kable(enews_email_rem) %>% kable_styling(latex_options = "scale_down")
}
}

```


\FloatBarrier
## The same participant received multiple eNewsletter sms notifications on the same day. 
```{r enews_sms, echo=FALSE, message=FALSE, warning=FALSE}
enews_sms <- "SELECT distinct(p.Connect_ID), #distinct(n.token), 
category,
       DATE(notification_time) as repeat_date, 
       COUNT(*) as num_same_day_attempts
FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.notifications_JP` n
left join  `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` p
on p.token=n.token
WHERE category='eNewsletter' and date(notification_time) >= (CURRENT_DATE()-7) and 
notificationType='sms'
GROUP BY Connect_ID,category, DATE(notification_time)
HAVING COUNT(*) > 1"

enews_sms_table <- bq_project_query(project, enews_sms)
enews_sms_rem <- bq_table_download(enews_sms_table, bigint = "integer64") #currently 5 - all 2


if (nrow(enews_sms_rem) > 50) {
  cat("There are", nrow(enews_sms_rem), "errors. This table has been made a csv and posted to Box, link in the report intro.")
  write.csv(enews_sms_rem,glue("{local_drive}Multiple_enews_sms_rem_reminders_{currentDate}_boxfolder_{boxfolder}.csv"),row.names = F,na="")
} else {
  if(nrow(enews_sms_rem) == 0) {
  cat("No errors\n")
} else {
  knitr::kable(enews_sms_rem) %>% kable_styling(latex_options = "scale_down")
}
}

```

\FloatBarrier
## The same participant received multiple aniversary Newsletter email notifications on the same day. 
```{r anews_email, echo=FALSE, message=FALSE, warning=FALSE}
anews_email <- "SELECT distinct(p.Connect_ID), #distinct(n.token), 
category,
       DATE(notification_time) as repeat_date, 
       COUNT(*) as num_same_day_attempts
FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.notifications_JP` n
left join  `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` p
on p.token=n.token
WHERE category='anniversaryNewsletter' and date(notification_time) >= (CURRENT_DATE()-7) and 
notificationType='email'
GROUP BY Connect_ID,category, DATE(notification_time)
HAVING COUNT(*) > 1"

anews_email_table <- bq_project_query(project, anews_email)
anews_email_rem <- bq_table_download(anews_email_table, bigint = "integer64") #currently 5 - all 2


if (nrow(anews_email_rem) > 50) {
  cat("There are", nrow(anews_email_rem), "errors. This table has been made a csv and posted to Box, link in the report intro.")
  write.csv(anews_email_rem,glue("{local_drive}Multiple_anews_email_rem_reminders_{currentDate}_boxfolder_{boxfolder}.csv"),row.names = F,na="")
} else {
  if(nrow(anews_email_rem) == 0) {
  cat("No errors\n")
} else {
  knitr::kable(anews_email_rem) %>% kable_styling(latex_options = "scale_down")
}
}

```


\FloatBarrier
## The same participant received multiple aniversary Newsletter text notifications on the same day. 
```{r anews_sms, echo=FALSE, message=FALSE, warning=FALSE}
anews_sms <- "SELECT distinct(p.Connect_ID), #distinct(n.token), 
category,
       DATE(notification_time) as repeat_date, 
       COUNT(*) as num_same_day_attempts
FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.notifications_JP` n
left join  `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` p
on p.token=n.token
WHERE category='anniversaryNewsletter' and date(notification_time) >= (CURRENT_DATE()-7) and 
notificationType='sms'
GROUP BY Connect_ID,category, DATE(notification_time)
HAVING COUNT(*) > 1"

anews_sms_table <- bq_project_query(project, anews_sms)
anews_sms_rem <- bq_table_download(anews_sms_table, bigint = "integer64") #currently 5 - all 2


if (nrow(anews_sms_rem) > 50) {
  cat("There are", nrow(anews_sms_rem), "errors. This table has been made a csv and posted to Box, link in the report intro.")
  write.csv(anews_sms_rem,glue("{local_drive}Multiple_anews_sms_rem_reminders_{currentDate}_boxfolder_{boxfolder}.csv"),row.names = F,na="")
} else {
  if(nrow(anews_sms_rem) == 0) {
  cat("No errors\n")
} else {
  knitr::kable(anews_sms_rem) %>% kable_styling(latex_options = "scale_down")
}
}

```


\FloatBarrier
## The same participant received multiple post-consent user profile reminders on the same day. 
```{r PCUP, echo=FALSE, message=FALSE, warning=FALSE}
PCUP <- "SELECT distinct(p.Connect_ID), #distinct(n.token), 
category,
       DATE(notification_time) as repeat_date, 
       COUNT(*) as num_same_day_attempts
FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.notifications_JP` n
left join  `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` p
on p.token=n.token
WHERE category LIKE '%post-consent user profile reminders%' and date(notification_time) >= (CURRENT_DATE()-7)
#AND notificationType = 'email'
GROUP BY Connect_ID,category, DATE(notification_time)
HAVING COUNT(*) > 1"

PCUP_table <- bq_project_query(project, PCUP)
PC_UserPf_rem <- bq_table_download(PCUP_table, bigint = "integer64") #currently 10 - all 2


if (nrow(PC_UserPf_rem) > 50) {
  cat("There are", nrow(PC_UserPf_rem), "errors. This table has been made a csv and posted to Box, link in the report intro.")
  write.csv(PC_UserPf_rem,glue("{local_drive}Multiple_PC_UserPf_rem_reminders_{currentDate}_boxfolder_{boxfolder}.csv"),row.names = F,na="")
} else {
  if(nrow(PC_UserPf_rem) == 0) {
  cat("No errors\n")
} else {
  knitr::kable(PC_UserPf_rem) %>% kable_styling(latex_options = "scale_down")
}
}
```



\FloatBarrier

## The same participant received multiple Verified, BL Survey SMS Reminders on the same day. This includes the category 'Verified, BL Survey Reminders New Pts'
```{r VBLSR_sms, echo=FALSE, message=FALSE, warning=FALSE}
VBLSR_sms <- "SELECT distinct(p.Connect_ID), #distinct(n.token), 
category,
       DATE(notification_time) as repeat_date, 
       COUNT(*) as num_same_day_attempts
FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.notifications_JP` n
left join  `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` p
on p.token=n.token
WHERE category LIKE 'Verified, BL Survey Reminders%' and date(notification_time) >= (CURRENT_DATE()-7) and 
notificationType='sms'
and notificationType='sms'
GROUP BY Connect_ID,category, DATE(notification_time)
HAVING COUNT(*) > 1"

VBLSR_sms_table <- bq_project_query(project, VBLSR_sms)
Ver_BLSurv_rem_sms <- bq_table_download(VBLSR_sms_table, bigint = "integer64")


if (nrow(Ver_BLSurv_rem_sms) > 50) {
  cat("There are", nrow(Ver_BLSurv_rem_sms), "errors. This table has been made a csv and posted to Box, link in the report intro.")
  write.csv(Ver_BLSurv_rem_sms,glue("{local_drive}Multiple_Ver_BLSurv_rem_sms_reminders_{currentDate}_boxfolder_{boxfolder}.csv"),row.names = F,na="")
} else {
  if(nrow(Ver_BLSurv_rem_sms) == 0) {
  cat("No errors\n")
} else {
  knitr::kable(Ver_BLSurv_rem_sms) %>% kable_styling(latex_options = "scale_down")
}
}
```



\FloatBarrier
## The same participant received multiple Verified, BL Survey email reminders on the same day. This includes the category 'Verified, BL Survey Reminders New Pts'
```{r VBLSR_email, echo=FALSE, message=FALSE, warning=FALSE}
VBLSR_email <- "SELECT distinct(p.Connect_ID), #distinct(n.token), 
category,
       DATE(notification_time) as repeat_date, 
       COUNT(*) as num_same_day_attempts
FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.notifications_JP` n
left join  `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` p
on p.token=n.token
WHERE category LIKE 'Verified, BL Survey Reminders%' and date(notification_time) >= (CURRENT_DATE()-7) and 
notificationType='email'
and notificationType='email'
GROUP BY Connect_ID,category, DATE(notification_time)
HAVING COUNT(*) > 1"

VBLSR_email_table <- bq_project_query(project, VBLSR_email)
Ver_BLSurv_rem_email <- bq_table_download(VBLSR_email_table, bigint = "integer64")


if (nrow(Ver_BLSurv_rem_email) > 50) {
  cat("There are", nrow(Ver_BLSurv_rem_email), "errors. This table has been made a csv and posted to Box, link in the report intro.")
  write.csv(Ver_BLSurv_rem_email,glue("{local_drive}Multiple_Ver_BLSurv_rem_reminders_{currentDate}_boxfolder_{boxfolder}.csv"),row.names = F,na="")
} else {
  if(nrow(Ver_BLSurv_rem_email) == 0) {
  cat("No errors\n")
} else {
  knitr::kable(Ver_BLSurv_rem_email) %>% kable_styling(latex_options = "scale_down")
}
}
```

\FloatBarrier
## The same participant received multiple Withdrawal reminders on the same day. 
```{r WD, echo=FALSE, message=FALSE, warning=FALSE}
WD <- "SELECT distinct(p.Connect_ID), #distinct(n.token), 
category,
       DATE(notification_time) as repeat_date, 
       COUNT(*) as num_same_day_attempts
FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.notifications_JP` n
left join  `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` p
on p.token=n.token
WHERE category LIKE '%Withdrawal Reminders%' and date(notification_time) >= (CURRENT_DATE()-7)
#AND notificationType = 'email'
GROUP BY Connect_ID,category, DATE(notification_time)
HAVING COUNT(*) > 1"

WD_table <- bq_project_query(project, WD)
WD_rem <- bq_table_download(WD_table, bigint = "integer64") #currently 4 - all 2


if (nrow(WD_rem) > 50) {
  cat("There are", nrow(WD_rem), "errors. This table has been made a csv and posted to Box, link in the report intro.")
  write.csv(WD_rem,glue("{local_drive}Multiple_WD_rem_reminders_{currentDate}_boxfolder_{boxfolder}.csv"),row.names = F,na="")
} else {
  if(nrow(WD_rem) == 0) {
  cat("No errors\n")
} else {
  knitr::kable(WD_rem) %>% kable_styling(latex_options = "scale_down")
}
}

```

\FloatBarrier
## The same participant received multiple (non-KPHI) Baseline Mouthwash Home Collection Kit SMS Reminders on the same day. 


```{r MWHC_text, echo=FALSE, message=FALSE, warning=FALSE}

##It looks like there's a category "Biospecimen Home Collection Kit Reminder" which is an email reminder and then a category "Baseline Mouthwash Home Collection Kit Reminders" that is a sms reminder. Not sure why those has different names as opposed to being the same name and why both wouldn't be considered a first attempt


MWHC <- "SELECT DISTINCT p.Connect_ID, 
                MIN(category) AS category,
                DATE(notification_time) AS repeat_date, 
                COUNT(*) AS num_same_day_attempts
FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.notifications_JP` n
LEFT JOIN `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` p
ON p.token = n.token
WHERE (category='Baseline Mouthwash Home Collection Kit Reminders' OR 
       category='Biospecimen Home Collection Kit Reminders' OR
       category='Biospecimen Home Collection Kit Reminders')
AND DATE(notification_time) >= (CURRENT_DATE() - 7)
AND notificationType = 'sms' and p.d_827220437!='300267574'
GROUP BY Connect_ID,repeat_date
HAVING COUNT(*) > 1"

MWHC_table <- bq_project_query(project, MWHC)
MWHC_rem <- bq_table_download(MWHC_table, bigint = "integer64") #currently 4 - all 2


if (nrow(MWHC_rem) > 50) {
  cat("There are", nrow(MWHC_rem), "errors. This table has been made a csv and posted to Box, link in the report intro.")
  write.csv(MWHC_rem,glue("{local_drive}Multiple_MWHC_text_rem_reminders_{currentDate}_boxfolder_{boxfolder}.csv"),row.names = F,na="")
} else {
  if(nrow(MWHC_rem) == 0) {
  cat("No errors\n")
} else {
  knitr::kable(MWHC_rem) %>% kable_styling(latex_options = "scale_down")
}
}

```


\FloatBarrier

## The same participant received multiple (non-KPHI) Baseline Mouthwash Home Collection Kit email Reminders on the same day. 

\FloatBarrier
```{r MWHC_email, echo=FALSE, message=FALSE, warning=FALSE}

##It looks like there's a category "Biospecimen Home Collection Kit Reminder" which is an email reminder and then a category "Baseline Mouthwash Home Collection Kit Reminders" that is a sms reminder. Not sure why those has different names as opposed to being the same name and why both wouldn't be considered a first attempt


MWHC <- "SELECT DISTINCT p.Connect_ID, 
                MIN(category) AS category,
                DATE(notification_time) AS repeat_date, 
                COUNT(*) AS num_same_day_attempts
FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.notifications_JP` n
LEFT JOIN `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` p
ON p.token = n.token
WHERE (category='Baseline Mouthwash Home Collection Kit Reminders' OR category='Biospecimen Home Collection Kit Reminders')
AND DATE(notification_time) >= (CURRENT_DATE() - 7)
AND notificationType = 'email' and p.d_827220437!='300267574'
GROUP BY Connect_ID,repeat_date
HAVING COUNT(*) > 1"

MWHC_table <- bq_project_query(project, MWHC)
MWHC_rem <- bq_table_download(MWHC_table, bigint = "integer64") #currently 4 - all 2


if (nrow(MWHC_rem) > 50) {
  cat("There are", nrow(MWHC_rem), "errors. This table has been made a csv and posted to Box, link in the report intro.")
  write.csv(MWHC_rem,glue("{local_drive}Multiple_MWHC_email_rem_reminders_{currentDate}_boxfolder_{boxfolder}.csv"),row.names = F,na="")
} else {
  if(nrow(MWHC_rem) == 0) {
  cat("No errors\n")
} else {
  knitr::kable(MWHC_rem) %>% kable_styling(latex_options = "scale_down")
}
}

```



\FloatBarrier
# The same participant received multiple Baseline Mouthwash Home Collection Kit SMS Reminders: KPHI  on the same day. 


```{r MWHC_KPHI_text, echo=FALSE, message=FALSE, warning=FALSE}


MWHC_KPHI <- "SELECT DISTINCT p.Connect_ID, 
                MAX(category) AS category,
                DATE(notification_time) AS repeat_date, 
                COUNT(*) AS num_same_day_attempts
FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.notifications_JP` n
LEFT JOIN `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` p
ON p.token = n.token
WHERE (category='Baseline Mouthwash Home Collection Kit Reminders: KPHI' OR category='Biospecimen Home Collection Kit Reminders') 
AND DATE(notification_time) >= (CURRENT_DATE() - 7)
AND notificationType = 'sms' and p.d_827220437='300267574'
GROUP BY Connect_ID,repeat_date
HAVING COUNT(*) > 1
"

MWHC_KPHI_table <- bq_project_query(project, MWHC_KPHI)
MWHC_KPHI_rem <- bq_table_download(MWHC_KPHI_table, bigint = "integer64") #currently 4 - all 2


if (nrow(MWHC_KPHI_rem) > 50) {
  cat("There are", nrow(MWHC_KPHI_rem), "errors. This table has been made a csv and posted to Box, link in the report intro.")
  write.csv(MWHC_KPHI_rem,glue("{local_drive}Multiple_MWHC_KPHI_text_rem_reminders_{currentDate}_boxfolder_{boxfolder}.csv"),row.names = F,na="")
} else {
  if(nrow(MWHC_KPHI_rem) == 0) {
  cat("No errors\n")
} else {
  knitr::kable(MWHC_KPHI_rem) %>% kable_styling(latex_options = "scale_down")
}
}


```



\FloatBarrier
# The same participant received multiple Baseline Mouthwash Home Collection Kit email Reminders: KPHI  on the same day. 

```{r MWHC_KPHI_email, echo=FALSE, message=FALSE, warning=FALSE}


MWHC_KPHI <- "SELECT DISTINCT p.Connect_ID, 
                MAX(category) AS category,
                DATE(notification_time) AS repeat_date, 
                COUNT(*) AS num_same_day_attempts
FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.notifications_JP` n
LEFT JOIN `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` p
ON p.token = n.token
WHERE (category='Baseline Mouthwash Home Collection Kit Reminders: KPHI' OR category='Biospecimen Home Collection Kit Reminders') 
AND DATE(notification_time) >= (CURRENT_DATE() - 7)
AND notificationType = 'email' and p.d_827220437='300267574'
GROUP BY Connect_ID,repeat_date
HAVING COUNT(*) > 1"

MWHC_KPHI_table <- bq_project_query(project, MWHC_KPHI)
MWHC_KPHI_rem <- bq_table_download(MWHC_KPHI_table, bigint = "integer64") #currently 4 - all 2


if (nrow(MWHC_KPHI_rem) > 50) {
  cat("There are", nrow(MWHC_KPHI_rem), "errors. This table has been made a csv and posted to Box, link in the report intro.")
  write.csv(MWHC_KPHI_rem,glue("{local_drive}Multiple_MWHC_KPHI_email_rem_reminders_{currentDate}_boxfolder_{boxfolder}.csv"),row.names = F,na="")
} else {
  if(nrow(MWHC_KPHI_rem) == 0) {
  cat("No errors\n")
} else {
  knitr::kable(MWHC_KPHI_rem) %>% kable_styling(latex_options = "scale_down")
}
}


```



\FloatBarrier
# The same participant received multiple Baseline Mouthwash Sample Survey email Reminders on the same day.

```{r MW_Srvy_email, echo=FALSE, message=FALSE, warning=FALSE}

MW_Srvy <- "SELECT DISTINCT p.Connect_ID, 
                MIN(category) AS category,
                DATE(notification_time) AS repeat_date, 
                COUNT(*) AS num_same_day_attempts
FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.notifications_JP` n
LEFT JOIN `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` p
ON p.token = n.token
WHERE (category = 'Baseline Mouthwash Sample Survey Reminders'
       OR category = 'Biospecimen Home Collection Survey Reminder')
AND DATE(notification_time) >= (CURRENT_DATE() - 7)
AND notificationType = 'email'
GROUP BY Connect_ID,repeat_date
HAVING COUNT(*) > 1"

MW_Srvy_table <- bq_project_query(project, MW_Srvy)
MW_Srvy_rem <- bq_table_download(MW_Srvy_table, bigint = "integer64") #currently 4 - all 2


if (nrow(MW_Srvy_rem) > 50) {
  cat("There are", nrow(MW_Srvy_rem), "errors. This table has been made a csv and posted to Box, link in the report intro.")
  write.csv(MW_Srvy_rem,glue("{local_drive}Multiple_MW_Srvy_email_rem_reminders_{currentDate}_boxfolder_{boxfolder}.csv"),row.names = F,na="")
} else {
  if(nrow(MW_Srvy_rem) == 0) {
  cat("No errors\n")
} else {
  knitr::kable(MW_Srvy_rem) %>% kable_styling(latex_options = "scale_down")
}
}

```


\FloatBarrier
# The same participant received multiple Mouthwash Home Collection Acknowledgement email Reminders on the same day. 

```{r MW_Acknowlegde_email, echo=FALSE, message=FALSE, warning=FALSE}

MW_Collection <- "SELECT DISTINCT p.Connect_ID, 
                MIN(category) AS category,
                DATE(notification_time) AS repeat_date, 
                COUNT(*) AS num_same_day_attempts
FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.notifications_JP` n
LEFT JOIN `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` p
ON p.token = n.token
WHERE (category = 'Mouthwash Home Collection Acknowledgement')
AND DATE(notification_time) >= (CURRENT_DATE() - 7)
AND notificationType = 'email'
GROUP BY Connect_ID,repeat_date
HAVING COUNT(*) > 1"

MW_Collection_table <- bq_project_query(project, MW_Collection)
MW_Collection_rem <- bq_table_download(MW_Collection_table, bigint = "integer64") #currently 4 - all 2


if (nrow(MW_Collection_rem) > 50) {
  cat("There are", nrow(MW_Collection_rem), "errors. This table has been made a csv and posted to Box, link in the report intro.")
  write.csv(MW_Collection_rem,glue("{local_drive}Multiple_MW_Collection_text_rem_reminders_{currentDate}_boxfolder_{boxfolder}.csv"),row.names = F,na="")
} else {
  if(nrow(MW_Collection_rem) == 0) {
  cat("No errors\n")
} else {
  knitr::kable(MW_Collection_rem) %>% kable_styling(latex_options = "scale_down")
}
}

```


\FloatBarrier


# 3. Participants receiving attempts out of order, meaning that they received "2nd contact" attempt or higher but not the "1st contact" attempt. Several categories are excluded from this query if the first attempt has a different category name then the remaining contact attempts; backlogs are also excluded.

\FloatBarrier

```{r OOO, echo=FALSE, message=FALSE, warning=FALSE}


OOO <- "
SELECT
  n.token,
  n.category,
  n.attempt,
  n.notification_time,
  p.Connect_ID
FROM
  `nih-nci-dceg-connect-prod-6d04.FlatConnect.notifications_JP` n
LEFT JOIN
  `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` p
ON
  n.token = p.token
WHERE
  n.token IS NOT NULL
  AND n.category NOT LIKE '%Contact%'
  AND n.category NOT LIKE '%contact%'
  AND n.category NOT IN (
    'Baseline Research Biospecimen Survey Reminders',
    'Baseline Clinical Blood and Urine Sample Survey Reminders',
    'newsletter',
    'Biospecimen Home Collection Survey Reminder'
  )
  AND DATE(n.notification_time) >= (CURRENT_DATE() - 7)
"


OOO_table <- bq_project_query(project, OOO)
OOO_rem <- bq_table_download(OOO_table, bigint = "integer64", n_max = Inf, page_size = 500)

# Check if attempts are out of order
OOO_rem <- OOO_rem %>%
  mutate(
    attempt_num = as.numeric(sub(" .*", "", attempt))
  ) %>%
  arrange(token, category, attempt_num, notification_time) %>%
  group_by(token, category) %>%
  filter(any(attempt_num != lag(attempt_num, default = 0) + 1))


if (nrow(OOO_rem) > 0) {
  print(OOO_rem)
} else {
  cat("No out-of-order attempts found.")
}


if (nrow(OOO_rem) > 50) {
  cat("There are", nrow(OOO_rem), "errors. This table has been made a csv and posted to Box, link in the report intro.")
  write.csv(OOO_rem, glue("{local_drive}Multiple_OOO_rem_reminders_{currentDate}_boxfolder_{boxfolder}.csv"), row.names = FALSE, na = "")
} else {
  if (nrow(OOO_rem) == 0) {
    cat("No errors\n")
  } else {
    knitr::kable(OOO_rem) %>% kable_styling(latex_options = "HOLD_position")
  }
}


```





\FloatBarrier


# 4. Number of messages per day this past week, compared to the specID daily averages since March 1,2024.

```{r NumMess, echo=FALSE, message=FALSE, warning=FALSE}


overage <- "WITH daily_counts AS (
    SELECT notificationType,
        category,
        attempt,
        notificationSpecificationsID,
        DATE(notification_time) AS notification_date,
        COUNT(*) AS daily_count
    FROM
        `nih-nci-dceg-connect-prod-6d04.FlatConnect.notifications_JP`
    WHERE
        DATE(notification_time) > '2024-02-29'
        AND notificationSpecificationsID IS NOT NULL
    GROUP BY notificationType,
        category,
        attempt,
        notificationSpecificationsID,
        notification_date
),

average_daily AS (
    SELECT notificationType,
        category,
        attempt,
        notificationSpecificationsID,
        AVG(daily_count) AS average_daily_notifications
    FROM
        daily_counts
    GROUP BY notificationType,
        category,
        attempt,
        notificationSpecificationsID
)

SELECT dc.notificationType,
    dc.category,
    dc.attempt,
    dc.notificationSpecificationsID,
    dc.notification_date,
    dc.daily_count,
    ad.average_daily_notifications
FROM
    daily_counts dc
JOIN
    average_daily ad
ON
    dc.notificationType = ad.notificationType
    AND dc.category = ad.category
    AND dc.attempt = ad.attempt
    AND dc.notificationSpecificationsID = ad.notificationSpecificationsID
WHERE
    dc.notification_date >= (CURRENT_DATE() - 7)
ORDER BY dc.notificationType,
    dc.category,
    dc.attempt;

"



overage_table <- bq_project_query(project, overage)
overage_rem <- bq_table_download(overage_table, bigint = "integer64") #currently 390



if (nrow(overage_rem) > 50) {
  cat("There are", nrow(overage_rem), "rows. This table has been made a csv and posted to Box, link in the report intro.")
  write.csv(overage_rem,glue("{local_drive}Daily_Contact_Attempt_Count_{currentDate}_boxfolder_{boxfolder}.csv"),row.names = F,na="")
} else {
  if(nrow(overage_rem) == 0) {
  cat("No rows\n")
} else {
  knitr::kable(overage_rem) %>% kable_styling(latex_options = "scale_down")
}
}



#HP Baseline Research Biospecimen Scheduling Invitation----- DEFUNCT, NO LONGER BEING SENT
#Baseline Biospecimen Scheduling Invitation----- DEFUNCT, NO LONGER BEING SENT
#Baseline Research Menstrual Cycle Survey Reminder 1, Baseline Research Menstrual Cycle Survey Reminder 2nd/3rd/4th contact----- DEFUNCT, NO LONGER BEING SENT
#KPHI Support Message----- DEFUNCT, NO LONGER BEING SENT
#MF Baseline Biospecimen Scheduling Invitation----- DEFUNCT, NO LONGER BEING SENT
#Post-verification biospecimen update KPCO/KPGA/KPNW/KPHI----- DEFUNCT, NO LONGER BEING SENT
#Verified, BL Survey Reminder Backlog Pts/Verified, BL Survey Reminders 2nd attempt/ Verified, BL Survey Reminders New Pts 7th/8th/9th Contact----- DEFUNCT, NO LONGER BEING SENT

```


